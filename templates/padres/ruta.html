{% extends "base.html" %}

{% block title %} - Seguimiento de Ruta{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-geo-alt"></i> Seguimiento de Ruta
        </h2>
        <a href="{{ url_for('padre_dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
    
    <div class="row">
        <!-- Informaci√≥n principal -->
        <div class="col-lg-8 mb-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bus-front"></i> {{ estudiante.nombre }} - Seguimiento en Tiempo Real
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Mapa en tiempo real (Leaflet) -->
                    <div id="map" class="rounded mb-4" style="height: 300px;"></div>
                    <div class="small text-muted">
                        √öltima actualizaci√≥n: <span id="lastUpdate">-</span>
                    </div>
                    
                    <!-- Informaci√≥n de la ruta -->
                    {% if ruta %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="bi bi-signpost"></i> Informaci√≥n de Ruta</h6>
                                    <p><strong>Nombre:</strong> {{ ruta.nombre }}</p>
                                    <p><strong>Hora inicio:</strong> {{ ruta.hora_inicio }}</p>
                                    {% if ruta.hora_fin %}
                                    <p><strong>Hora fin:</strong> {{ ruta.hora_fin }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6><i class="bi bi-person-badge"></i> Conductor</h6>
                                    {% if conductor %}
                                    <p><strong>Nombre:</strong> {{ conductor.nombre }}</p>
                                    {% if conductor.telefono %}
                                    <p><strong>Tel√©fono:</strong> {{ conductor.telefono }}</p>
                                    {% endif %}
                                    {% else %}
                                    <p class="text-muted">Conductor no asignado</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paradas -->
                    {% if paradas %}
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-geo"></i> Paradas de la Ruta</h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group">
                                {% for parada in paradas %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ parada.nombre }}</h6>
                                        {% if parada.hora %}
                                        <small>{{ parada.hora }}</small>
                                        {% endif %}
                                    </div>
                                    {% if parada.direccion %}
                                    <p class="mb-1"><small>{{ parada.direccion }}</small></p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        Este estudiante no tiene una ruta asignada.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Panel lateral -->
        <div class="col-lg-4 mb-4">
            <!-- Notificaciones -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="bi bi-bell"></i> Notificaciones</h5>
                </div>
                <div class="card-body">
                    <div id="notificationsList">
                        {% if asistencias_recientes %}
                            {% for asistencia in asistencias_recientes %}
                            <div class="alert alert-info mb-2 p-2">
                                <small>
                                    <i class="bi bi-check-circle"></i>
                                    {{ asistencia.tipo|capitalize }}: 
                                    {{ asistencia.fecha.strftime('%H:%M') }}
                                </small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center py-3">
                                <i class="bi bi-bell-slash"></i><br>
                                No hay notificaciones recientes
                            </p>
                        {% endif %}
                    </div>
                    
                    <button class="btn btn-outline-warning w-100 mt-2" onclick="simularNotificacion()">
                        <i class="bi bi-bell"></i> Simular Notificaci√≥n
                    </button>
                </div>
            </div>
            
            <!-- Controles -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Controles</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="actualizarUbicacion()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar Ubicaci√≥n
                        </button>
                        <button class="btn btn-outline-primary" onclick="contactarConductor()">
                            <i class="bi bi-chat"></i> Contactar Conductor
                        </button>
                        <button class="btn btn-outline-success" onclick="enviarMensaje()">
                            <i class="bi bi-envelope"></i> Enviar Mensaje
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let map;
let marker;
const conductorId = {{ conductor.id if conductor else 0 }};
let lastUpdateValue = null;
let hasCentered = false;

function initMap() {
    const initialLat = {{ ubicacion_vehiculo.lat if ubicacion_vehiculo else 12.1364 }};
    const initialLng = {{ ubicacion_vehiculo.lng if ubicacion_vehiculo else -86.2514 }};
    
    map = L.map('map').setView([initialLat, initialLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    
    marker = L.marker([initialLat, initialLng]).addTo(map);
}

function actualizarUbicacion() {
    if (!conductorId) return;
    fetch(`/api/conductor/${conductorId}/ubicacion`)
        .then(res => res.json())
        .then(data => {
            if (!data.success) return;
            const lat = data.lat;
            const lng = data.lng;
            marker.setLatLng([lat, lng]);
            if (!hasCentered) {
                map.setView([lat, lng], 15);
                hasCentered = true;
            } else {
                map.panTo([lat, lng], { animate: true, duration: 1.0 });
            }
            document.getElementById('lastUpdate').textContent = data.ultima_actualizacion;
            if (data.ultima_actualizacion !== lastUpdateValue) {
                notificarActualizacion();
                lastUpdateValue = data.ultima_actualizacion;
            }
        })
        .catch(() => {});
}

// Notificaci√≥n simple cuando se actualiza la ubicaci√≥n
function notificarActualizacion() {
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show mb-2';
    notification.innerHTML = `
        <i class="bi bi-check-circle"></i> Ubicaci√≥n actualizada
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    const list = document.getElementById('notificationsList');
    if (list) list.prepend(notification);
}

function contactarConductor() {
    alert('üìû En una implementaci√≥n real, esto abrir√≠a el tel√©fono para llamar al conductor.');
}

function enviarMensaje() {
    const message = prompt('Escribe tu mensaje para el conductor:');
    if (message) {
        alert(`‚úÖ Mensaje enviado: "${message}"`);
    }
}

function simularNotificacion() {
    const notifications = [
        "üöå El veh√≠culo est√° a 5 minutos de la parada",
        "üìç Veh√≠culo en camino a la escuela",
        "‚úÖ Estudiante ha abordado el veh√≠culo",
        "üè´ Llegada a la escuela en 10 minutos"
    ];
    
    const randomNotif = notifications[Math.floor(Math.random() * notifications.length)];
    const now = new Date();
    const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0');
    
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show mb-2';
    notification.innerHTML = `
        <i class="bi bi-bell"></i> ${randomNotif} (${timeString})
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.getElementById('notificationsList').prepend(notification);
    
    // Tambi√©n mostrar notificaci√≥n push si est√° permitido
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Camley Transporte', {
            body: randomNotif,
            icon: '/static/icon-192.png'
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initMap();
    actualizarUbicacion();
    setInterval(actualizarUbicacion, 5000);
});
</script>
{% endblock %}
